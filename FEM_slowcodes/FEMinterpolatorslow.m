function Efield=FEMinterpolator(ro,x,te2p,p,rs,js,FEMord);
%% compute primary E-field
nsource=numel(rs(1,:));
nobs=numel(ro(1,:));
mu0=1.25663706*10^-6;
acc=2;
[Ux]=lfmm3dpart(acc,nsource,rs,1,js(1,:)',...
    0,zeros([1 nsource]),zeros([3 nsource]),0,0,nobs,ro,1,0);
[Uy]=lfmm3dpart(acc,nsource,rs,1,js(2,:)',...
    0,zeros([1 nsource]),zeros([3 nsource]),0,0,nobs,ro,1,0);
[Uz]=lfmm3dpart(acc,nsource,rs,1,js(3,:)',...
    0,zeros([1 nsource]),zeros([3 nsource]),0,0,nobs,ro,1,0);
Efield=zeros([3 nobs]);
Efield(1,:)=-mu0*real(Ux.pottarg(:))'/(4*pi);
Efield(2,:)=-mu0*real(Uy.pottarg(:))'/(4*pi);
Efield(3,:)=-mu0*real(Uz.pottarg(:))'/(4*pi);
%define basis functions
fast_det2=@(pm,a,b) pm(1)*(a(2)*b(3)-a(3)*b(2))-pm(2)*(a(1)*b(3)-a(3)*b(1))+pm(3)*(a(1)*b(2)-a(2)*b(1));
fast_det=@(a,b) (a(2)*b(3)-a(3)*b(2))-(a(1)*b(3)-a(3)*b(1))+(a(1)*b(2)-a(2)*b(1));
aval=@(x,y,z) [ fast_det2([x(2),x(3),x(4)],[y(2),y(3),y(4)],[z(2),z(3),z(4)]),...
               -fast_det2([x(1),x(3),x(4)],[y(1),y(3),y(4)],[z(1),z(3),z(4)]),...
                fast_det2([x(1),x(2),x(4)],[y(1),y(2),y(4)],[z(1),z(2),z(4)]),...
               -fast_det2([x(1),x(2),x(3)],[y(1),y(2),y(3)],[z(1),z(2),z(3)])];
bval=@(x,y,z) [-fast_det([y(2),y(3),y(4)],[z(2),z(3),z(4)]),...
                fast_det([y(1),y(3),y(4)],[z(1),z(3),z(4)]),...
               -fast_det([y(1),y(2),y(4)],[z(1),z(2),z(4)]),...
                fast_det([y(1),y(2),y(3)],[z(1),z(2),z(3)])];
cval=@(x,y,z) [ fast_det([x(2),x(3),x(4)],[z(2),z(3),z(4)]),...
               -fast_det([x(1),x(3),x(4)],[z(1),z(3),z(4)]),...
                fast_det([x(1),x(2),x(4)],[z(1),z(2),z(4)]),...
               -fast_det([x(1),x(2),x(3)],[z(1),z(2),z(3)])];
dval=@(x,y,z) [-fast_det([x(2),x(3),x(4)],[y(2),y(3),y(4)]),...
                fast_det([x(1),x(3),x(4)],[y(1),y(3),y(4)]),...
               -fast_det([x(1),x(2),x(4)],[y(1),y(2),y(4)]),...
                fast_det([x(1),x(2),x(3)],[y(1),y(2),y(3)])];
L =@(a,b,c,d,pos,cons) (a+b*pos(1)+c*pos(2)+d*pos(3))/cons;
[~,gradL]=loadbasis(FEMord);
%% compute secondary E-fields
TR=triangulation(double(te2p(1:4,:)'),p');
%[id,BC] = pointLocation(TR,ro(1,:)',ro(2,:)',ro(3,:)');  %alternate way of computing
[id] = pointLocation(TR,ro(1,:)',ro(2,:)',ro(3,:)');
for i=1:nobs
    tetra=id(i);
    if isnan(tetra)
    else
        a=aval(p(1,te2p(1:4,tetra)),p(2,te2p(1:4,tetra)),p(3,te2p(1:4,tetra)));
        b=bval(p(1,te2p(1:4,tetra)),p(2,te2p(1:4,tetra)),p(3,te2p(1:4,tetra)));
        c=cval(p(1,te2p(1:4,tetra)),p(2,te2p(1:4,tetra)),p(3,te2p(1:4,tetra)));
        d=dval(p(1,te2p(1:4,tetra)),p(2,te2p(1:4,tetra)),p(3,te2p(1:4,tetra)));
        sixvol=sum(a);
        Lvals=L(a(:),b(:),c(:),d(:),ro(:,i),sixvol); 
        % Lvals=BC(i,:); %alternate way of computing
        ggg=gradL(b(:),c(:),d(:),Lvals,sixvol);

        Efield(:,i)=Efield(:,i)-ggg*x(te2p(:,tetra));
    end
end

end

function [Lmat,gradL,nbasis]=loadbasis(FEMord)
if FEMord==1
    nbasis=4;
Lmat=@(Lvals) cat(2,...
Lvals(1),Lvals(2),Lvals(3),Lvals(4));
gradL  =@(b,c,d,Lvals,cons) cat(2,...
[b(1);c(1);d(1)]/cons,...
[b(2);c(2);d(2)]/cons,...
[b(3);c(3);d(3)]/cons,...
[b(4);c(4);d(4)]/cons);
elseif FEMord==2
    nbasis=10;
Lmat=@(Lvals) cat(2,...
Lvals(1)*(2*Lvals(1)-1),...
Lvals(2)*(2*Lvals(2)-1),...
Lvals(3)*(2*Lvals(3)-1),...
Lvals(4)*(2*Lvals(4)-1),...
4*Lvals(1)*Lvals(2),...
4*Lvals(1)*Lvals(3),...
4*Lvals(1)*Lvals(4),...
4*Lvals(2)*Lvals(3),...
4*Lvals(2)*Lvals(4),...
4*Lvals(3)*Lvals(4)...
);
gradL  =@(b,c,d,Lvals,cons) cat(2,...
(4*Lvals(1)-1)*[b(1);c(1);d(1)]/cons,...
(4*Lvals(2)-1)*[b(2);c(2);d(2)]/cons,...
(4*Lvals(3)-1)*[b(3);c(3);d(3)]/cons,...
(4*Lvals(4)-1)*[b(4);c(4);d(4)]/cons,...
 4*(Lvals(1)*[b(2);c(2);d(2)]+Lvals(2)*[b(1);c(1);d(1)])/cons,...
 4*(Lvals(1)*[b(3);c(3);d(3)]+Lvals(3)*[b(1);c(1);d(1)])/cons,...
 4*(Lvals(1)*[b(4);c(4);d(4)]+Lvals(4)*[b(1);c(1);d(1)])/cons,...
 4*(Lvals(2)*[b(3);c(3);d(3)]+Lvals(3)*[b(2);c(2);d(2)])/cons,...
 4*(Lvals(2)*[b(4);c(4);d(4)]+Lvals(4)*[b(2);c(2);d(2)])/cons,...
 4*(Lvals(3)*[b(4);c(4);d(4)]+Lvals(4)*[b(3);c(3);d(3)])/cons);
elseif FEMord==3
    nbasis=20;
    Lmat=@(Lvals) cat(2,...
Lvals(1)*(3*Lvals(1)-1)*(3*Lvals(1)-2)/2,...
Lvals(2)*(3*Lvals(2)-1)*(3*Lvals(2)-2)/2,...
Lvals(3)*(3*Lvals(3)-1)*(3*Lvals(3)-2)/2,...
Lvals(4)*(3*Lvals(4)-1)*(3*Lvals(4)-2)/2,...
9*Lvals(1)*Lvals(2)*(3*Lvals(1)-1)/2,...
9*Lvals(1)*Lvals(2)*(3*Lvals(2)-1)/2,...
9*Lvals(1)*Lvals(3)*(3*Lvals(1)-1)/2,...
9*Lvals(1)*Lvals(3)*(3*Lvals(3)-1)/2,...
9*Lvals(1)*Lvals(4)*(3*Lvals(1)-1)/2,...
9*Lvals(1)*Lvals(4)*(3*Lvals(4)-1)/2,...
9*Lvals(2)*Lvals(3)*(3*Lvals(2)-1)/2,...
9*Lvals(2)*Lvals(3)*(3*Lvals(3)-1)/2,...
9*Lvals(2)*Lvals(4)*(3*Lvals(2)-1)/2,...
9*Lvals(2)*Lvals(4)*(3*Lvals(4)-1)/2,...
9*Lvals(3)*Lvals(4)*(3*Lvals(3)-1)/2,...
9*Lvals(3)*Lvals(4)*(3*Lvals(4)-1)/2,...
27*Lvals(1)*Lvals(2)*Lvals(3),...
27*Lvals(1)*Lvals(2)*Lvals(4),...
27*Lvals(1)*Lvals(3)*Lvals(4),...
27*Lvals(2)*Lvals(3)*Lvals(4)...
);
gradL  =@(b,c,d,Lvals,cons) cat(2,...
(27*Lvals(1)^2-18*Lvals(1)+2)/2*[b(1);c(1);d(1)],...
(27*Lvals(2)^2-18*Lvals(2)+2)/2*[b(2);c(2);d(2)],...
(27*Lvals(3)^2-18*Lvals(3)+2)/2*[b(3);c(3);d(3)],...
(27*Lvals(4)^2-18*Lvals(4)+2)/2*[b(4);c(4);d(4)],...
9*(6*Lvals(2)*Lvals(1)-Lvals(2))/2*[b(1);c(1);d(1)]+...
9*(3*Lvals(1)^2-Lvals(1))/2*[b(2);c(2);d(2)],...
9*(6*Lvals(1)*Lvals(2)-Lvals(1))/2*[b(2);c(2);d(2)]+...
9*(3*Lvals(2)^2-Lvals(2))/2*[b(1);c(1);d(1)],...
9*(6*Lvals(3)*Lvals(1)-Lvals(3))/2*[b(1);c(1);d(1)]+...
9*(3*Lvals(1)^2-Lvals(1))/2*[b(3);c(3);d(3)],...
9*(6*Lvals(1)*Lvals(3)-Lvals(1))/2*[b(3);c(3);d(3)]+...
9*(3*Lvals(3)^2-Lvals(3))/2*[b(1);c(1);d(1)],...
9*(6*Lvals(4)*Lvals(1)-Lvals(4))/2*[b(1);c(1);d(1)]+...
9*(3*Lvals(1)^2-Lvals(1))/2*[b(4);c(4);d(4)],...
9*(6*Lvals(1)*Lvals(4)-Lvals(1))/2*[b(4);c(4);d(4)]+...
9*(3*Lvals(4)^2-Lvals(4))/2*[b(1);c(1);d(1)],...
9*(6*Lvals(3)*Lvals(2)-Lvals(3))/2*[b(2);c(2);d(2)]+...
9*(3*Lvals(2)^2-Lvals(2))/2*[b(3);c(3);d(3)],...
9*(6*Lvals(2)*Lvals(3)-Lvals(2))/2*[b(3);c(3);d(3)]+...
9*(3*Lvals(3)^2-Lvals(3))/2*[b(2);c(2);d(2)],...
9*(6*Lvals(4)*Lvals(2)-Lvals(4))/2*[b(2);c(2);d(2)]+...
9*(3*Lvals(2)^2-Lvals(2))/2*[b(4);c(4);d(4)],...
9*(6*Lvals(2)*Lvals(4)-Lvals(2))/2*[b(4);c(4);d(4)]+...
9*(3*Lvals(4)^2-Lvals(4))/2*[b(2);c(2);d(2)],...
9*(6*Lvals(4)*Lvals(3)-Lvals(4))/2*[b(3);c(3);d(3)]+...
9*(3*Lvals(3)^2-Lvals(3))/2*[b(4);c(4);d(4)],...
9*(6*Lvals(3)*Lvals(4)-Lvals(3))/2*[b(4);c(4);d(4)]+...
9*(3*Lvals(4)^2-Lvals(4))/2*[b(3);c(3);d(3)],...
27*(Lvals(1)*Lvals(2)*[b(3);c(3);d(3)]+...
    Lvals(2)*Lvals(3)*[b(1);c(1);d(1)]+...
    Lvals(3)*Lvals(1)*[b(2);c(2);d(2)]),...
27*(Lvals(1)*Lvals(2)*[b(4);c(4);d(4)]+...
    Lvals(2)*Lvals(4)*[b(1);c(1);d(1)]+...
    Lvals(4)*Lvals(1)*[b(2);c(2);d(2)]),...
27*(Lvals(1)*Lvals(4)*[b(3);c(3);d(3)]+...
    Lvals(4)*Lvals(3)*[b(1);c(1);d(1)]+...
    Lvals(3)*Lvals(1)*[b(4);c(4);d(4)]),...
27*(Lvals(4)*Lvals(2)*[b(3);c(3);d(3)]+...
    Lvals(2)*Lvals(3)*[b(4);c(4);d(4)]+...
    Lvals(3)*Lvals(4)*[b(2);c(2);d(2)])...
)/cons;
end

end
